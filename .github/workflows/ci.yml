name: ShowRatesLoggerGUI Pipeline

on: 
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]

env:
    DOTNET_VERSION: '9.0.x'
    BUILD_CONFIGURATION: 'Release' 

jobs:
    build:
        name: Build
        runs-on: windows-latest

        steps:
            - uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v3
              with:
                dotnet-version: ${{ env.DOTNET_VERSION }}

            - name: Restore dependencies
              run: dotnet restore

            - name: Build
              run: dotnet build --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

            - name: Publish
              run: dotnet publish -c ${{ env.BUILD_CONFIGURATION }} -o ./ShowRatesLoggerGUI --self-contained

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                name: ShowRatesLoggerGUI-package
                path: ./ShowRatesLoggerGUI
                retention-days: 1
    release:
      name: Create Release
      needs: build
      runs-on: ubuntu-latest
      if: github.ref == 'refs/heads/main'
      permissions:
        contents: write
        packages: write

      steps:
        - name: Download Artifact
          uses: actions/download-artifact@v4
          with:
            name: ShowRatesLoggerGUI-package
            path: release-files

        - name: List download files (debug)
          run: ls -R release-files

        - name: Create Release
          id: create_release
          uses: softprops/action-gh-release@v1
          with:
            tag_name: v${{ github.run_number }}
            name: Release v${{ github.run_number }}
            body: |
              Automatic release of build ${{ github.run_number }}
              Commit: ${{ github.sha }} 
            draft: false
            prerelease: false
            files: |
              ShowRatesLoggerGUI-package/*
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        - name: Upload Release Asset
          uses: actions/upload-release-asset@v1
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: release-files/ShowRatesLoggerGUI-package
            asset_name: ShowRatesLoggerGUI-V${{ github.run_number }}.zip
            asset_content_type: application/zip
